name: 'Build JASP desktop'

on:
   push:
     paths: ['**/JASP*.yml']

jobs:
      
   build-jasp:
   
    runs-on: ubuntu-latest
    env:
       GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
       
    name:  deb build on ubuntu-latest
        
    steps:
      - uses: actions/checkout@v3
      
      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3.1'
           
      - name: Rtools installation
        run: |
           install.packages("renv")
        shell: Rscript {0}

      - name: Install Qt6
        uses: jurplel/install-qt-action@v3
        with:
            version: 6.4.*
            aqtversion: '==3.1.*'
            host: 'linux'
            target: 'desktop'
            arch: 'gcc_64'
            modules: 'qtpositioning qtwebchannel qtwebengine qtwebsockets qtwebview debug_info qt5compat qtshadertools qtwaylandcompositor'
            tools: 'tools_qtcreator,qt.tools.qtcreator tools_ninja tools_cmake'
            
      - name: Install dependencies of build system
        run: |     
            sudo apt install libboost-dev libjsoncpp25 libjsoncpp-dev libarchive13 libarchive-dev
            sudo apt install libxcb-xkb-dev libxcb-xkb1 libxcb-xinerama0 libxkbcommon-dev libxkbcommon-x11-dev autoconf zlib1g zlib1g-dev cmake
            sudo apt install gfortran build-essential flex libssl-dev libgl1-mesa-dev libsqlite3-dev r-base
            sudo apt install jags
            sudo dpkg -L jags
            
      - name: Install boost
        uses: MarkusJx/install-boost@v2.4.4
        id: install-boost
        with:
            # REQUIRED: Specify the required boost version
            # A list of supported versions can be found here:
            # https://github.com/MarkusJx/prebuilt-boost/blob/main/versions-manifest.json
            boost_version: 1.81.0

      - name: Install Readstat
        run: |
            wget https://github.com/WizardMac/ReadStat/releases/download/v1.1.9/readstat-1.1.9.tar.gz
            tar -xzf readstat-*.tar.gz && cd readstat-*/
            ./configure
            make
            sudo make install
        
      - name: Build JASP desktop
        run: |
            git clone  https://github.com/jasp-stats/jasp-desktop.git
            #mkdir /home/runner/work/BuildBot/BuildBot/jasp-release/R/library && sudo chmod -R 777 "/home/runner/work/BuildBot/BuildBot/jasp-release/R/library"
            #Rscript -e "dir.create(Sys.getenv("R_LIBS_USER"), recursive = TRUE)"
            #Rscript -e ".libPaths(Sys.getenv("R_LIBS_USER"))"
            cmake -S ./jasp-desktop -B ./jasp-release
            # cmake -build ./jasp-release --target all
            -DBoost_INCLUDE_DIR=${{steps.install-boost.outputs.BOOST_ROOT}}/include\
            -DBoost_LIBRARY_DIRS=${{steps.install-boost.outputs.BOOST_ROOT}}/lib
        env:
            BOOST_ROOT: ${{ steps.install-boost.outputs.BOOST_ROOT }}
            R_HOME: "/usr/lib/R/"
            jags_HOME: "/usr/lib/x86_64-linux-gnu/"
            LIBJAGS: "/usr/lib/x86_64-linux-gnu/libjags.so"
            
